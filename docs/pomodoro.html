<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pomodoro | Focus</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Syne:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg:        #0A0907;
      --surface:   #141210;
      --surface-2: #1E1A16;
      --border:    #2A2420;
      --text:      #F5F0E8;
      --muted:     #6B5E52;
      --muted-2:   #2E2620;
      --active:    #FF6B35;
      --glow:      rgba(255, 107, 53, 0.28);
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Syne', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
    }

    /* Grain overlay */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.05'/%3E%3C/svg%3E");
      pointer-events: none;
      z-index: 0;
    }

    /* Ambient glow behind ring */
    .glow-orb {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -58%);
      width: 500px;
      height: 500px;
      border-radius: 50%;
      background: radial-gradient(ellipse, var(--glow) 0%, transparent 68%);
      pointer-events: none;
      z-index: 0;
      transition: background 0.8s ease;
    }

    /* Back link */
    .back {
      position: fixed;
      top: 22px;
      left: 24px;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--muted);
      text-decoration: none;
      z-index: 20;
      transition: color 0.2s;
    }
    .back:hover { color: var(--text); }

    /* Container */
    .wrap {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 28px;
      animation: rise 0.5s cubic-bezier(0.22,1,0.36,1) forwards;
    }
    @keyframes rise {
      from { opacity: 0; transform: translateY(16px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* Mode tabs */
    .modes {
      display: flex;
      gap: 3px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 3px;
    }
    .mode-btn {
      padding: 5px 14px;
      font-family: 'Syne', sans-serif;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--muted);
      background: transparent;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: color 0.2s, background 0.2s;
    }
    .mode-btn.active {
      color: var(--active);
      background: var(--surface-2);
    }
    .mode-btn:hover:not(.active) { color: var(--text); }

    /* Ring */
    .ring-wrap {
      position: relative;
      width: 300px;
      height: 300px;
    }
    .ring-svg {
      width: 100%;
      height: 100%;
      transform: rotate(-90deg);
    }
    .ring-track {
      fill: none;
      stroke: var(--surface-2);
      stroke-width: 5;
    }
    .ring-fill {
      fill: none;
      stroke: var(--active);
      stroke-width: 5;
      stroke-linecap: round;
      transition: stroke-dashoffset 1s linear, stroke 0.6s ease;
      filter: drop-shadow(0 0 5px var(--glow));
    }
    @keyframes pulse {
      0%, 100% { filter: drop-shadow(0 0 5px var(--glow)); }
      50%       { filter: drop-shadow(0 0 16px var(--glow)); }
    }
    .ring-fill.ticking { animation: pulse 2.4s ease-in-out infinite; }

    /* Center */
    .ring-center {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 2px;
    }
    .time {
      font-family: 'DM Mono', monospace;
      font-size: 68px;
      font-weight: 300;
      letter-spacing: -0.03em;
      color: var(--text);
      line-height: 1;
      transition: color 0.3s;
    }
    .mode-tag {
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--active);
      transition: color 0.6s;
    }

    @keyframes flash {
      0%,100% { opacity: 1; }
      25%,75%  { opacity: 0.25; }
    }
    .time.flash { animation: flash 0.6s ease; }

    /* Controls */
    .controls {
      display: flex;
      align-items: center;
      gap: 14px;
    }
    .btn-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--muted);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: color 0.2s, border-color 0.2s, transform 0.12s;
    }
    .btn-icon:hover { color: var(--text); border-color: var(--muted); }
    .btn-icon:active { transform: scale(0.9); }

    .btn-play {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: none;
      background: var(--active);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.15s, box-shadow 0.3s, background 0.6s;
      box-shadow: 0 0 0 0 var(--glow);
    }
    .btn-play:hover {
      transform: scale(1.07);
      box-shadow: 0 0 22px var(--glow);
    }
    .btn-play:active { transform: scale(0.93); }

    /* Session dots */
    .dots-row {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }
    .dots {
      display: flex;
      align-items: center;
      gap: 7px;
    }
    .dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--muted-2);
      border: 1px solid var(--border);
      transition: background 0.3s, border-color 0.3s, transform 0.2s;
    }
    .dot.done {
      background: var(--active);
      border-color: var(--active);
    }
    .dot.done:last-child { transform: scale(1.25); }
    .dot-sep {
      width: 1px;
      height: 10px;
      background: var(--border);
    }
    .session-label {
      font-family: 'DM Mono', monospace;
      font-size: 11px;
      color: var(--muted);
      letter-spacing: 0.04em;
    }

    /* Settings */
    .settings {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .toggle-row {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      user-select: none;
    }
    .toggle-lbl {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
    }
    .toggle {
      width: 30px;
      height: 17px;
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 9px;
      position: relative;
      transition: background 0.2s, border-color 0.2s;
    }
    .toggle::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 11px;
      height: 11px;
      border-radius: 50%;
      background: var(--muted);
      transition: transform 0.2s, background 0.2s;
    }
    .toggle.on {
      background: color-mix(in srgb, var(--active) 20%, transparent);
      border-color: var(--active);
    }
    .toggle.on::after {
      transform: translateX(13px);
      background: var(--active);
    }

    /* Keyboard hints */
    .hints {
      display: flex;
      gap: 14px;
    }
    .hint {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 10px;
      color: var(--muted);
      letter-spacing: 0.04em;
    }
    kbd {
      font-family: 'DM Mono', monospace;
      font-size: 9px;
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 3px;
      padding: 1px 5px;
      color: var(--muted);
    }

    /* Log button */
    .log-btn {
      position: fixed;
      bottom: 22px;
      right: 24px;
      font-family: 'Syne', sans-serif;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
      background: none;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      z-index: 20;
      transition: color 0.2s;
    }
    .log-btn:hover { color: var(--text); }

    /* Log panel */
    .log-panel {
      position: fixed;
      bottom: 56px;
      right: 24px;
      width: 260px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      max-height: 0;
      opacity: 0;
      z-index: 20;
      transition: max-height 0.3s ease, opacity 0.25s;
    }
    .log-panel.open { max-height: 230px; opacity: 1; }

    .log-head {
      padding: 9px 13px;
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--muted);
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .log-clear-btn {
      font-size: 9px;
      font-family: 'Syne', sans-serif;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--muted);
      background: none;
      border: none;
      cursor: pointer;
      transition: color 0.2s;
    }
    .log-clear-btn:hover { color: var(--active); }

    .log-scroll {
      max-height: 180px;
      overflow-y: auto;
      padding: 6px 0;
    }
    .log-scroll::-webkit-scrollbar { width: 3px; }
    .log-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    .log-row {
      padding: 5px 13px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .log-row-lbl {
      font-size: 11px;
      color: var(--text);
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .log-row-time {
      font-family: 'DM Mono', monospace;
      font-size: 10px;
      color: var(--muted);
      flex-shrink: 0;
    }
    .log-empty {
      padding: 16px 13px;
      font-size: 11px;
      color: var(--muted);
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="glow-orb" id="glowOrb"></div>
  <a href="index.html" class="back">← Dashboard</a>

  <div class="wrap">

    <!-- Mode tabs -->
    <div class="modes" role="tablist">
      <button class="mode-btn active" data-mode="focus" onclick="setMode('focus')" role="tab" aria-selected="true">Focus</button>
      <button class="mode-btn" data-mode="short" onclick="setMode('short')" role="tab" aria-selected="false">Short break</button>
      <button class="mode-btn" data-mode="long" onclick="setMode('long')" role="tab" aria-selected="false">Long break</button>
    </div>

    <!-- Ring -->
    <div class="ring-wrap" role="timer" aria-live="off">
      <svg class="ring-svg" viewBox="0 0 300 300">
        <circle class="ring-track" cx="150" cy="150" r="130"/>
        <circle class="ring-fill" cx="150" cy="150" r="130" id="ring"/>
      </svg>
      <div class="ring-center">
        <div class="time" id="display">25:00</div>
        <div class="mode-tag" id="modeTag">Focus</div>
      </div>
    </div>

    <!-- Controls -->
    <div class="controls">
      <button class="btn-icon" onclick="resetTimer()" title="Reset (R)" aria-label="Reset timer">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
          <path d="M3 3v5h5"/>
        </svg>
      </button>

      <button class="btn-play" onclick="toggleTimer()" id="btnPlay" aria-label="Start or pause">
        <svg id="iconPlay" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><polygon points="5,3 19,12 5,21"/></svg>
        <svg id="iconPause" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="display:none">
          <rect x="6" y="4" width="4" height="16" rx="1"/>
          <rect x="14" y="4" width="4" height="16" rx="1"/>
        </svg>
      </button>

      <button class="btn-icon" onclick="skipSession()" title="Skip" aria-label="Skip to next session">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
          <polygon points="5,4 15,12 5,20"/>
          <line x1="19" y1="5" x2="19" y2="19"/>
        </svg>
      </button>
    </div>

    <!-- Session dots -->
    <div class="dots-row">
      <div class="dots">
        <div class="dot" id="dot0"></div>
        <div class="dot" id="dot1"></div>
        <div class="dot" id="dot2"></div>
        <div class="dot-sep"></div>
        <div class="dot" id="dot3"></div>
      </div>
      <div class="session-label" id="sessLabel">0 sessions today</div>
    </div>

    <!-- Settings -->
    <div class="settings">
      <div class="toggle-row" onclick="toggleAuto()" role="switch" tabindex="0" aria-label="Auto-advance toggle" onkeydown="if(event.key==='Enter'||event.key===' ')toggleAuto()">
        <div class="toggle" id="autoToggle"></div>
        <span class="toggle-lbl">Auto-advance</span>
      </div>
    </div>

    <!-- Keyboard hints -->
    <div class="hints">
      <div class="hint"><kbd>Space</kbd> start / pause</div>
      <div class="hint"><kbd>R</kbd> reset</div>
      <div class="hint"><kbd>1</kbd><kbd>2</kbd><kbd>3</kbd> mode</div>
    </div>

  </div>

  <!-- Log -->
  <button class="log-btn" onclick="toggleLog()">
    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <rect x="3" y="4" width="18" height="18" rx="2"/>
      <line x1="16" y1="2" x2="16" y2="6"/>
      <line x1="8" y1="2" x2="8" y2="6"/>
      <line x1="3" y1="10" x2="21" y2="10"/>
    </svg>
    Session log
  </button>

  <div class="log-panel" id="logPanel">
    <div class="log-head">
      Today
      <button class="log-clear-btn" onclick="clearLog()">Clear</button>
    </div>
    <div class="log-scroll" id="logScroll"></div>
  </div>

  <script>
    // ── Config ──────────────────────────────────────────────────────
    const MODES = {
      focus: { label: 'Focus',       mins: 25, color: '#FF6B35', glow: 'rgba(255,107,53,0.28)'  },
      short: { label: 'Short break', mins: 5,  color: '#4ECDC4', glow: 'rgba(78,205,196,0.28)'  },
      long:  { label: 'Long break',  mins: 15, color: '#A8D8EA', glow: 'rgba(168,216,234,0.28)' },
    };

    const CIRC = 2 * Math.PI * 130; // r=130

    // ── State ───────────────────────────────────────────────────────
    let mode     = 'focus';
    let total    = MODES.focus.mins * 60;
    let rem      = total;
    let ticking  = false;
    let iv       = null;
    let autoAdv  = false;
    let setPos   = 0; // 0–3 within current pomodoro set
    const TODAY  = new Date().toDateString();
    let log      = JSON.parse(localStorage.getItem('pomo-log2') || '[]').filter(e => e.date === TODAY);

    // ── DOM ─────────────────────────────────────────────────────────
    const ring      = document.getElementById('ring');
    const display   = document.getElementById('display');
    const modeTag   = document.getElementById('modeTag');
    const iconPlay  = document.getElementById('iconPlay');
    const iconPause = document.getElementById('iconPause');
    const autoTgl   = document.getElementById('autoToggle');
    const glowOrb   = document.getElementById('glowOrb');

    // ── Init ────────────────────────────────────────────────────────
    ring.style.strokeDasharray  = CIRC;
    ring.style.strokeDashoffset = 0;
    refresh();
    renderLog();

    // ── Timer ───────────────────────────────────────────────────────
    function toggleTimer() { ticking ? pause() : play(); }

    function play() {
      if (rem <= 0) return;
      ticking = true;
      ring.classList.add('ticking');
      iconPlay.style.display  = 'none';
      iconPause.style.display = '';
      iv = setInterval(tick, 1000);
      updateTitle();
    }

    function pause() {
      ticking = false;
      ring.classList.remove('ticking');
      iconPlay.style.display  = '';
      iconPause.style.display = 'none';
      clearInterval(iv);
      document.title = 'Pomodoro | Focus';
    }

    function tick() {
      if (rem <= 0) { complete(); return; }
      rem--;
      refresh();
      updateTitle();
    }

    function complete() {
      pause();
      chime();
      display.classList.add('flash');
      setTimeout(() => display.classList.remove('flash'), 700);

      if (mode === 'focus') {
        setPos = (setPos + 1) % 4;
        log.push({
          date:  TODAY,
          time:  new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
          label: `Focus · ${MODES.focus.mins} min`,
        });
        saveLog();
        renderLog();
        updateDots();
        updateSessLabel();
      }

      if (autoAdv) {
        setTimeout(() => {
          const next = mode === 'focus' ? (setPos === 0 ? 'long' : 'short') : 'focus';
          setMode(next);
          play();
        }, 1400);
      }
    }

    function resetTimer() {
      pause();
      rem = total;
      refresh();
    }

    function skipSession() {
      const next = mode === 'focus' ? (setPos === 3 ? 'long' : 'short') : 'focus';
      setMode(next);
      if (autoAdv) play();
    }

    // ── Mode ────────────────────────────────────────────────────────
    function setMode(m) {
      pause();
      mode  = m;
      total = MODES[m].mins * 60;
      rem   = total;

      const cfg = MODES[m];
      document.documentElement.style.setProperty('--active', cfg.color);
      document.documentElement.style.setProperty('--glow',   cfg.glow);
      glowOrb.style.background = `radial-gradient(ellipse, ${cfg.glow} 0%, transparent 68%)`;

      document.querySelectorAll('.mode-btn').forEach(b => {
        const on = b.dataset.mode === m;
        b.classList.toggle('active', on);
        b.setAttribute('aria-selected', on);
      });

      modeTag.textContent = cfg.label;
      refresh();
    }

    // ── Display ─────────────────────────────────────────────────────
    function refresh() {
      const m = String(Math.floor(rem / 60)).padStart(2, '0');
      const s = String(rem % 60).padStart(2, '0');
      display.textContent = `${m}:${s}`;
      ring.style.strokeDashoffset = CIRC * (1 - rem / total);
    }

    function updateTitle() {
      const m = String(Math.floor(rem / 60)).padStart(2, '0');
      const s = String(rem % 60).padStart(2, '0');
      document.title = `${m}:${s} · ${MODES[mode].label}`;
    }

    // ── Dots ─────────────────────────────────────────────────────────
    function updateDots() {
      const todayTotal = log.length;
      const pos = todayTotal % 4;
      for (let i = 0; i < 4; i++) {
        document.getElementById('dot' + i).classList.toggle('done', i < pos);
      }
    }

    function updateSessLabel() {
      const n = log.length;
      document.getElementById('sessLabel').textContent = `${n} session${n !== 1 ? 's' : ''} today`;
    }

    // ── Auto-advance ─────────────────────────────────────────────────
    function toggleAuto() {
      autoAdv = !autoAdv;
      autoTgl.classList.toggle('on', autoAdv);
    }

    // ── Log ──────────────────────────────────────────────────────────
    function saveLog() {
      const all = JSON.parse(localStorage.getItem('pomo-log2') || '[]')
        .filter(e => e.date !== TODAY)
        .concat(log);
      localStorage.setItem('pomo-log2', JSON.stringify(all));
    }

    function renderLog() {
      updateSessLabel();
      updateDots();
      const el = document.getElementById('logScroll');
      if (!log.length) {
        el.innerHTML = '<div class="log-empty">No sessions yet today.</div>';
        return;
      }
      el.innerHTML = [...log].reverse().map(e => `
        <div class="log-row">
          <span class="log-row-lbl">${e.label}</span>
          <span class="log-row-time">${e.time}</span>
        </div>
      `).join('');
    }

    function clearLog() {
      log = [];
      saveLog();
      renderLog();
    }

    function toggleLog() {
      document.getElementById('logPanel').classList.toggle('open');
    }

    // ── Chime (Web Audio) ────────────────────────────────────────────
    function chime() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        [523.25, 659.25, 783.99].forEach((freq, i) => {
          const osc  = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.connect(gain);
          gain.connect(ctx.destination);
          osc.type = 'sine';
          osc.frequency.value = freq;
          const t = ctx.currentTime + i * 0.13;
          gain.gain.setValueAtTime(0, t);
          gain.gain.linearRampToValueAtTime(0.25, t + 0.025);
          gain.gain.exponentialRampToValueAtTime(0.001, t + 0.45);
          osc.start(t);
          osc.stop(t + 0.45);
        });
      } catch (_) {}
    }

    // ── Keyboard ──────────────────────────────────────────────────────
    document.addEventListener('keydown', e => {
      if (['INPUT','TEXTAREA'].includes(e.target.tagName)) return;
      if (e.key === ' ')          { e.preventDefault(); toggleTimer(); }
      else if (e.key === 'r' || e.key === 'R') resetTimer();
      else if (e.key === '1')     setMode('focus');
      else if (e.key === '2')     setMode('short');
      else if (e.key === '3')     setMode('long');
    });
  </script>
</body>
</html>
